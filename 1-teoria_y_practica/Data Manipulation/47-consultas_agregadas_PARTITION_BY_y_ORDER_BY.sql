-- ======================================================
-- === CONSULTAS AGREGADAS - PARTITION BY y ORDER BY ====
-- ======================================================

-- =====================
-- === PARTITION BY  ===
-- =====================

--  Lo que hace PARTITION BY es refinar el rango o las filas que vamos a tomar. Va a hacer una sección
--  discreta.

USE EJERCICIOS

--  Ejemplo 1

SELECT * FROM tblAttendance

/*
|----------------|-----------------|------------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance |
|----------------|-----------------|------------------|
|      123	     |    2014-01-01   |	    14        |
|      123	     |    2014-02-01   |	    12        |
|      123	     |    2014-03-01   |	    23        |  
|      123       |    2014-04-01   | 	    21        |  
|      123       |    2014-05-01   |    	23        |  
|      123       |    2014-06-01   |	    14        |  
|      123       |    2014-07-01   |	    11        |  
|      123       |    2014-08-01   | 	    15        |  
|      123	     |    2014-09-01   | 	    14        |  
|      123	     |    2014-10-01   | 	    20        |  
|      123	     |    2014-11-01   | 	    24        |  
|      123	     |    2014-12-01   | 	    14        |  
|      123	     |    2015-01-01   | 	    21        |  
|      123	     |    2015-02-01   | 	    16        |  
|      123	     |    2015-03-01   | 	    17        |  
|      123	     |    2015-04-01   | 	    13        |  
|      123	     |    2015-05-01   | 	    11        |  
|      123	     |    2015-06-01   | 	    18        |  
|      123	     |    2015-07-01   | 	    24        |  
|      123	     |    2015-08-01   | 	    15        |  
|      123	     |    2015-09-01   | 	    19        |  
|      123	     |    2015-10-01   | 	    20        |  
|      124	     |    2014-01-01   | 	    17        |  
|      124	     |    2014-02-01   | 	    17        |  
|      124	     |    2014-03-01   | 	    24        |  
|      124	     |    2014-04-01   | 	    12        |  
|      124	     |    2014-05-01   | 	    20        |
|   .........    |   ............  |    ..........    |
|   .........    |   ............  |    ..........    |
|----------------|-----------------|------------------| */

-- Obtenemos el suma total del campo "NumberAttendance" para cada fila, de acuerdo al total
-- de cada EmployeeNumber

SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber) TotalAttendance
FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |      379        |
|      123	     |    2014-02-01   |	    12        |      379        |
|      123	     |    2014-03-01   |	    23        |      379        |  
|      123       |    2014-04-01   | 	    21        |      379        |   
|      123       |    2014-05-01   |    	23        |      379        |  
|      123       |    2014-06-01   |	    14        |      379        |  
|      123       |    2014-07-01   |	    11        |      379        |  
|      123       |    2014-08-01   | 	    15        |      379        |  
|      123	     |    2014-09-01   | 	    14        |      379        |  
|      123	     |    2014-10-01   | 	    20        |      379        |  
|      123	     |    2014-11-01   | 	    24        |      379        |  
|      123	     |    2014-12-01   | 	    14        |      379        |  
|      123	     |    2015-01-01   | 	    21        |      379        |  
|      123	     |    2015-02-01   | 	    16        |      379        |  
|      123	     |    2015-03-01   | 	    17        |      379        |  
|      123	     |    2015-04-01   | 	    13        |      379        |  
|      123	     |    2015-05-01   | 	    11        |      379        |  
|      123	     |    2015-06-01   | 	    18        |      379        |  
|      123	     |    2015-07-01   | 	    24        |      379        |  
|      123	     |    2015-08-01   | 	    15        |      379        |  
|      123	     |    2015-09-01   | 	    19        |      379        |  
|      123	     |    2015-10-01   | 	    20        |      379        |  
|      124	     |    2014-01-01   | 	    17        |      427        |  
|      124	     |    2014-02-01   | 	    17        |      427        |  
|      124	     |    2014-03-01   | 	    24        |      427        |  
|      124	     |    2014-04-01   | 	    12        |      427        |  
|      124	     |    2014-05-01   | 	    20        |      427        |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| */


-- Obtenemos el suma total del campo "NumberAttendance" para cada fila, de acuerdo al total
-- de cada EmployeeNumber

SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber) TotalAttendance
FROM tblAttendance
WHERE AttendanceMonth < '20150101'

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |      205        |   
|      123	     |    2014-02-01   |	    12        |      205        |  
|      123	     |    2014-03-01   |	    23        |      205        |   
|      123       |    2014-04-01   | 	    21        |      205        |  
|      123       |    2014-05-01   |    	23        |      205        | 
|      123       |    2014-06-01   |	    14        |      205        |   
|      123       |    2014-07-01   |	    11        |      205        |  
|      123       |    2014-08-01   | 	    15        |      205        |   
|      123	     |    2014-09-01   | 	    14        |      205        |   
|      123	     |    2014-10-01   | 	    20        |      205        |   
|      123	     |    2014-11-01   | 	    24        |      205        |   
|      123	     |    2014-12-01   | 	    14        |      205        | 
|      124	     |    2014-01-01   | 	    17        |      228        |  
|      124	     |    2014-02-01   | 	    17        |      228        |  
|      124	     |    2014-03-01   | 	    24        |      228        |  
|      124	     |    2014-04-01   | 	    12        |      228        |   
|      124	     |    2014-05-01   | 	    20        |      228        |   
|   .........    |   ............  |    ..........    |   ...........   |  
|   .........    |   ............  |    ..........    |   ...........   |  
|----------------|-----------------|------------------|-----------------| */


SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber) TotalAttendance,
	   ROUND(CONVERT(DECIMAL(5,3), NumberAttendance)/SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber) * 100,4)  AS PercentageAttendance
FROM tblAttendance
WHERE AttendanceMonth < '20150101'

/*
|----------------|-----------------|------------------|-----------------|------------------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |  PercentageAttendance  |
|----------------|-----------------|------------------|-----------------|------------------------|
|      123	     |    2014-01-01   |	    14        |      205        |     6.82930000000000   | <---- Vemos como el valor de 'TotalAttendance' cambió 
|      123	     |    2014-02-01   |	    12        |      205        |     5.85370000000000   |       y eso provoca que 'PercentageAttendance' cambie 
|      123	     |    2014-03-01   |	    23        |      205        |    11.21950000000000   |       también.
|      123       |    2014-04-01   | 	    21        |      205        |    10.24390000000000   |  
|      123       |    2014-05-01   |    	23        |      205        |    11.21950000000000   | 
|      123       |    2014-06-01   |	    14        |      205        |     6.82930000000000   |   
|      123       |    2014-07-01   |	    11        |      205        |     5.36590000000000   |  
|      123       |    2014-08-01   | 	    15        |      205        |     7.31710000000000   |
|      123	     |    2014-09-01   | 	    14        |      205        |     6.82930000000000   |
|      123	     |    2014-10-01   | 	    20        |      205        |     9.75610000000000   |
|      123	     |    2014-11-01   | 	    24        |      205        |    11.70730000000000   |
|      123	     |    2014-12-01   | 	    14        |      205        |     6.82930000000000   |
|      124	     |    2014-01-01   | 	    17        |      228        |     7.45610000000000   |
|      124	     |    2014-02-01   | 	    17        |      228        |     7.45610000000000   |
|      124	     |    2014-03-01   | 	    24        |      228        |    10.52630000000000   |
|      124	     |    2014-04-01   | 	    12        |      228        |     5.26320000000000   |
|      124	     |    2014-05-01   | 	    20        |      228        |     8.77190000000000   |
|   .........    |   ............  |    ..........    |   ...........   |    ..................  |
|   .........    |   ............  |    ..........    |   ...........   |    ..................  |
|----------------|-----------------|------------------|-----------------|------------------------| 


    ===========================================================================================================

    Ejemplo 2

    Vamos a utilizar dos campos en PARTITION BY. En este ejemplo, se particionara la informacion en la columna
    'TotalAttendance' de acuerdo al campo EmployeeNumber y al Año del campo 'AttendanceMonth'  */

    SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth)) TotalAttendance
    FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |      205        |
|      123	     |    2014-02-01   |	    12        |      205        |
|      123	     |    2014-03-01   |	    23        |      205        |  
|      123       |    2014-04-01   | 	    21        |      205        |   
|      123       |    2014-05-01   |    	23        |      205        |  
|      123       |    2014-06-01   |	    14        |      205        |  
|      123       |    2014-07-01   |	    11        |      205        |  
|      123       |    2014-08-01   | 	    15        |      205        |  
|      123	     |    2014-09-01   | 	    14        |      205        |  
|      123	     |    2014-10-01   | 	    20        |      205        |  
|      123	     |    2014-11-01   | 	    24        |      205        |  
|      123	     |    2014-12-01   | 	    14        |      205        |  
|      123	     |    2015-01-01   | 	    21        |      174        |  
|      123	     |    2015-02-01   | 	    16        |      174        |  
|      123	     |    2015-03-01   | 	    17        |      174        |  
|      123	     |    2015-04-01   | 	    13        |      174        |  
|      123	     |    2015-05-01   | 	    11        |      174        |  
|      123	     |    2015-06-01   | 	    18        |      174        |  
|      123	     |    2015-07-01   | 	    24        |      174        |  
|      123	     |    2015-08-01   | 	    15        |      174        |  
|      123	     |    2015-09-01   | 	    19        |      174        |  
|      123	     |    2015-10-01   | 	    20        |      174        |  
|      124	     |    2014-01-01   | 	    17        |      228        |  
|      124	     |    2014-02-01   | 	    17        |      228        |  
|      124	     |    2014-03-01   | 	    24        |      228        |  
|      124	     |    2014-04-01   | 	    12        |      228        |  
|      124	     |    2014-05-01   | 	    20        |      228        |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| 




    ===========================================================================================================
    ===========================================================================================================

    ================
    === ORDER BY ===
    ================

    Lo que hace ORDER BY es generarnos un total acumulado  */

    USE EJERCICIOS

/*  Ejemplo 1

    Se realizó un acumulado en la columna 'TotalAttendance' a partir del EmployeeNumber, donde desde el 
    EmployeeNumber '124' se comenzo a acumular el total. 
    Se sumó: 
    TotalAttendance EmployeeNumber = 123 ----> 379
    TotalAttendance EmployeeNumber = 124 ----> 427
                                            -----------
                                               806

*/
    SELECT *, SUM(NumberAttendance) OVER(ORDER BY EmployeeNumber) TotalAttendance
    FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |      379        |
|      123	     |    2014-02-01   |	    12        |      379        |
|      123	     |    2014-03-01   |	    23        |      379        |  
|      123       |    2014-04-01   | 	    21        |      379        |   
|      123       |    2014-05-01   |    	23        |      379        |  
|      123       |    2014-06-01   |	    14        |      379        |  
|      123       |    2014-07-01   |	    11        |      379        |  
|      123       |    2014-08-01   | 	    15        |      379        |  
|      123	     |    2014-09-01   | 	    14        |      379        |  
|      123	     |    2014-10-01   | 	    20        |      379        |  
|      123	     |    2014-11-01   | 	    24        |      379        |  
|      123	     |    2014-12-01   | 	    14        |      379        |  
|      123	     |    2015-01-01   | 	    21        |      379        |  
|      123	     |    2015-02-01   | 	    16        |      379        |  
|      123	     |    2015-03-01   | 	    17        |      379        |  
|      123	     |    2015-04-01   | 	    13        |      379        |  
|      123	     |    2015-05-01   | 	    11        |      379        |  
|      123	     |    2015-06-01   | 	    18        |      379        |  
|      123	     |    2015-07-01   | 	    24        |      379        |  
|      123	     |    2015-08-01   | 	    15        |      379        |  
|      123	     |    2015-09-01   | 	    19        |      379        |  
|      123	     |    2015-10-01   | 	    20        |      379        |  
|      124	     |    2014-01-01   | 	    17        |      806        |  
|      124	     |    2014-02-01   | 	    17        |      806        |  
|      124	     |    2014-03-01   | 	    24        |      806        |  
|      124	     |    2014-04-01   | 	    12        |      806        |  
|      124	     |    2014-05-01   | 	    20        |      806        |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| 


    Se realizó un acumulado en la columna 'TotalAttendance' a partir del Mes, según el campo AttendanceMonth', 
    donde desde el EmployeeNumber '124' se comenzo a acumular el total. 
    Se sumó: 
    TotalAttendance AttendanceMonth = Mes 2014/01 ----> 1440
    TotalAttendance AttendanceMonth = Mes 2014/02 ----> 1497
                                                    -----------
                                                        2937
*/
    SELECT *, SUM(NumberAttendance) OVER(ORDER BY AttendanceMonth) TotalAttendance
    FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123       |	 2014-01-01	   |        14	      |      1440       |
|      124	     |   2014-01-01	   |        17	      |      1440       |
|      125	     |   2014-01-01	   |        12	      |      1440       |
|      126	     |   2014-01-01	   |        10	      |      1440       |
|      127	     |   2014-01-01	   |        19	      |      1440       |
|      128	     |   2014-01-01	   |        14	      |      1440       |
|      129	     |   2014-01-01	   |        26	      |      1440       |
|      130	     |   2014-01-01	   |        28	      |      1440       |
|      131	     |   2014-01-01	   |        12	      |      1440       |
|      132	     |   2014-01-01	   |        21	      |      1440       |
|      133	     |   2014-01-01	   |        10	      |      1440       |
|      134	     |   2014-01-01	   |        21	      |      1440       |
|      135	     |   2014-01-01	   |        21	      |      1440       |
|      136	     |   2014-01-01	   |        10	      |      1440       |
|      137	     |   2014-01-01	   |        16	      |      1440       |
|      138	     |   2014-01-01	   |        10	      |      1440       |
|      139	     |   2014-01-01	   |        23	      |      1440       |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|      199	     |   2014-01-01    |     	13	      |      1440       |
|      199	     |   2014-02-01	   |        20	      |      2937       |
|      198	     |   2014-02-01	   |        27	      |      2937       |
|      197	     |   2014-02-01	   |        16	      |      2937       |
|      196	     |   2014-02-01	   |        26	      |      2937       |
|      195	     |   2014-02-01	   |        10	      |      2937       |
|      194	     |   2014-02-01	   |        18	      |      2937       |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| */

/*
    ===========================================================================================================
    ===========================================================================================================

    ===============================
    === PARTITION BY + ORDER BY ===
    ===============================  */

    USE EJERCICIOS

/*  Ejemplo 1  */

    SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber ORDER BY AttendanceMonth) TotalAttendance
    FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |       14        |
|      123	     |    2014-02-01   |	    12        |       26        |
|      123	     |    2014-03-01   |	    23        |       49        |  
|      123       |    2014-04-01   | 	    21        |       70        |   
|      123       |    2014-05-01   |    	23        |       93        |  
|      123       |    2014-06-01   |	    14        |      107        |  
|      123       |    2014-07-01   |	    11        |      118        |  
|      123       |    2014-08-01   | 	    15        |      133        |  
|      123	     |    2014-09-01   | 	    14        |      147        |  
|      123	     |    2014-10-01   | 	    20        |      167        |  
|      123	     |    2014-11-01   | 	    24        |      191        |  
|      123	     |    2014-12-01   | 	    14        |      205        |  
|      123	     |    2015-01-01   | 	    21        |      226        |  
|      123	     |    2015-02-01   | 	    16        |      242        |  
|      123	     |    2015-03-01   | 	    17        |      259        |  
|      123	     |    2015-04-01   | 	    13        |      272        |  
|      123	     |    2015-05-01   | 	    11        |      283        |  
|      123	     |    2015-06-01   | 	    18        |      301        |  
|      123	     |    2015-07-01   | 	    24        |      325        |  
|      123	     |    2015-08-01   | 	    15        |      340        |  
|      123	     |    2015-09-01   | 	    19        |      359        |  
|      123	     |    2015-10-01   | 	    20        |      379        |  
|      124	     |    2014-01-01   | 	    17        |       17        |  
|      124	     |    2014-02-01   | 	    17        |       34        |  
|      124	     |    2014-03-01   | 	    24        |       58        |  
|      124	     |    2014-04-01   | 	    12        |       70        |  
|      124	     |    2014-05-01   | 	    20        |       90        |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| 

    También podemos dar un orden al total acumulado de manera descendente */

    SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber ORDER BY AttendanceMonth DESC) TotalAttendance
    FROM tblAttendance

--  También podemos dar un orden al total acumulado de manera descendente y además dar un orden especifico

    SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber ORDER BY AttendanceMonth DESC) TotalAttendance
    FROM tblAttendance
    ORDER BY EmployeeNumber, AttendanceMonth

/*
    ===========================================================================================================

    Ejemplo 2

    Vamos a utilizar dos campos en PARTITION BY. En este ejemplo, se particionara la informacion en la columna
    'TotalAttendance' de acuerdo al campo EmployeeNumber y al Año del campo 'AttendanceMonth'. De acuerdo a estas 
    particiones se generará un acumulado.  */

    SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth) ORDER BY AttendanceMonth) TotalAttendance
    FROM tblAttendance

--  Obtengo lo mismo también:

    SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth) ORDER BY EmployeeNumber) TotalAttendance
    FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |       14        |
|      123	     |    2014-02-01   |	    12        |       26        |
|      123	     |    2014-03-01   |	    23        |       49        |  
|      123       |    2014-04-01   | 	    21        |       70        |   
|      123       |    2014-05-01   |    	23        |       93        |  
|      123       |    2014-06-01   |	    14        |      107        |  
|      123       |    2014-07-01   |	    11        |      118        |  
|      123       |    2014-08-01   | 	    15        |      133        |  
|      123	     |    2014-09-01   | 	    14        |      147        |  
|      123	     |    2014-10-01   | 	    20        |      167        |  
|      123	     |    2014-11-01   | 	    24        |      191        |  
|      123	     |    2014-12-01   | 	    14        |      205        | <------------- 
|      123	     |    2015-01-01   | 	    21        |       21        |  
|      123	     |    2015-02-01   | 	    16        |       37        |  
|      123	     |    2015-03-01   | 	    17        |       54        |  
|      123	     |    2015-04-01   | 	    13        |       67        |  
|      123	     |    2015-05-01   | 	    11        |       78        |  
|      123	     |    2015-06-01   | 	    18        |       96        |  
|      123	     |    2015-07-01   | 	    24        |      120        |  
|      123	     |    2015-08-01   | 	    15        |      135        |  
|      123	     |    2015-09-01   | 	    19        |      154        |  
|      123	     |    2015-10-01   | 	    20        |      174        | <------------
|      124	     |    2014-01-01   | 	    17        |       17        |  
|      124	     |    2014-02-01   | 	    17        |       34        |  
|      124	     |    2014-03-01   | 	    24        |       58        |  
|      124	     |    2014-04-01   | 	    12        |       70        |  
|      124	     |    2014-05-01   | 	    20        |       90        |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| 