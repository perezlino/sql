-- ======================================================
-- =========== CONSULTAS AGREGADAS - OVER( ) ============
-- ======================================================

-- ==============
-- === OVER() ===
-- ==============

USE EJERCICIOS

--  Ejemplo 1

SELECT * FROM tblAttendance

/*
|----------------|-----------------|------------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance |
|----------------|-----------------|------------------|
|      123	     |    2014-01-01   |	    14        |
|      123	     |    2014-02-01   |	    12        |
|      123	     |    2014-03-01   |	    23        |  
|      123       |    2014-04-01   | 	    21        |  
|      123       |    2014-05-01   |    	23        |  
|      123       |    2014-06-01   |	    14        |  
|      123       |    2014-07-01   |	    11        |  
|      123       |    2014-08-01   | 	    15        |  
|      123	     |    2014-09-01   | 	    14        |  
|      123	     |    2014-10-01   | 	    20        |  
|      123	     |    2014-11-01   | 	    24        |  
|      123	     |    2014-12-01   | 	    14        |  
|      123	     |    2015-01-01   | 	    21        |  
|      123	     |    2015-02-01   | 	    16        |  
|      123	     |    2015-03-01   | 	    17        |  
|      123	     |    2015-04-01   | 	    13        |  
|      123	     |    2015-05-01   | 	    11        |  
|      123	     |    2015-06-01   | 	    18        |  
|      123	     |    2015-07-01   | 	    24        |  
|      123	     |    2015-08-01   | 	    15        |  
|      123	     |    2015-09-01   | 	    19        |  
|      123	     |    2015-10-01   | 	    20        |  
|      124	     |    2014-01-01   | 	    17        |  
|      124	     |    2014-02-01   | 	    17        |  
|      124	     |    2014-03-01   | 	    24        |  
|      124	     |    2014-04-01   | 	    12        |  
|      124	     |    2014-05-01   | 	    20        |
|   .........    |   ............  |    ..........    |
|   .........    |   ............  |    ..........    |
|----------------|-----------------|------------------| */


-- Obtenemos el suma total del campo "NumberAttendance" para cada fila

SELECT *, SUM(NumberAttendance) OVER() TotalAttendance
FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance |
|----------------|-----------------|------------------|-----------------|
|      123	     |    2014-01-01   |	    14        |      35409      |
|      123	     |    2014-02-01   |	    12        |      35409      |
|      123	     |    2014-03-01   |	    23        |      35409      |  
|      123       |    2014-04-01   | 	    21        |      35409      |  
|      123       |    2014-05-01   |    	23        |      35409      |  
|      123       |    2014-06-01   |	    14        |      35409      |  
|      123       |    2014-07-01   |	    11        |      35409      |  
|      123       |    2014-08-01   | 	    15        |      35409      |  
|      123	     |    2014-09-01   | 	    14        |      35409      |  
|      123	     |    2014-10-01   | 	    20        |      35409      |  
|      123	     |    2014-11-01   | 	    24        |      35409      |  
|      123	     |    2014-12-01   | 	    14        |      35409      |  
|      123	     |    2015-01-01   | 	    21        |      35409      |  
|      123	     |    2015-02-01   | 	    16        |      35409      |  
|      123	     |    2015-03-01   | 	    17        |      35409      |  
|      123	     |    2015-04-01   | 	    13        |      35409      |  
|      123	     |    2015-05-01   | 	    11        |      35409      |  
|      123	     |    2015-06-01   | 	    18        |      35409      |  
|      123	     |    2015-07-01   | 	    24        |      35409      |  
|      123	     |    2015-08-01   | 	    15        |      35409      |  
|      123	     |    2015-09-01   | 	    19        |      35409      |  
|      123	     |    2015-10-01   | 	    20        |      35409      |  
|      124	     |    2014-01-01   | 	    17        |      35409      |  
|      124	     |    2014-02-01   | 	    17        |      35409      |  
|      124	     |    2014-03-01   | 	    24        |      35409      |  
|      124	     |    2014-04-01   | 	    12        |      35409      |  
|      124	     |    2014-05-01   | 	    20        |      35409      |
|   .........    |   ............  |    ..........    |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |
|----------------|-----------------|------------------|-----------------| */


-- Calculamos el porcentaje sobre el total de "NumberAttendance" :

-- Cambiamos el tipo de dato del campo "NumberAttendance" dado que es del tipo SMALLINT. 
-- Y SMALLINT/SMALLINT = SMALLINT, por el contrario, DECIMAL/SMALLINT = DECIMAL

SELECT *, SUM(NumberAttendance) OVER() TotalAttendance,
	   ROUND(CONVERT(DECIMAL(5,3), NumberAttendance)/SUM(NumberAttendance) OVER() * 100,4)  AS PercentageAttendance
FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|----------------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance | PercentageAttendance |
|----------------|-----------------|------------------|-----------------|----------------------|
|      123	     |    2014-01-01   |	    14        |      35409      |   0.03950000000000   | 
|      123	     |    2014-02-01   |	    12        |      35409      |   0.03390000000000   | 
|      123	     |    2014-03-01   |	    23        |      35409      |   0.06500000000000   |    
|      123       |    2014-04-01   | 	    21        |      35409      |   0.05930000000000   |  
|      123       |    2014-05-01   |    	23        |      35409      |   0.06500000000000   | 
|      123       |    2014-06-01   |	    14        |      35409      |   0.03950000000000   |  
|      123       |    2014-07-01   |	    11        |      35409      |   0.03110000000000   |  
|      123       |    2014-08-01   | 	    15        |      35409      |   0.04240000000000   |
|      123	     |    2014-09-01   | 	    14        |      35409      |   0.03950000000000   |
|      123	     |    2014-10-01   | 	    20        |      35409      |   0.05650000000000   |
|      123	     |    2014-11-01   | 	    24        |      35409      |   0.06780000000000   |
|      123	     |    2014-12-01   | 	    14        |      35409      |   0.03950000000000   |
|      123	     |    2015-01-01   | 	    21        |      35409      |   0.05930000000000   |
|      123	     |    2015-02-01   | 	    16        |      35409      |   0.04520000000000   |
|      123	     |    2015-03-01   | 	    17        |      35409      |   0.04800000000000   |
|      123	     |    2015-04-01   | 	    13        |      35409      |   0.03670000000000   |
|      123	     |    2015-05-01   | 	    11        |      35409      |   0.03110000000000   |
|      123	     |    2015-06-01   | 	    18        |      35409      |   0.05080000000000   |
|      123	     |    2015-07-01   | 	    24        |      35409      |   0.06780000000000   |
|      123	     |    2015-08-01   | 	    15        |      35409      |   0.04240000000000   |   
|      123	     |    2015-09-01   | 	    19        |      35409      |   0.05370000000000   |    
|      123	     |    2015-10-01   | 	    20        |      35409      |   0.05650000000000   |
|      124	     |    2014-01-01   | 	    17        |      35409      |   0.04800000000000   |
|      124	     |    2014-02-01   | 	    17        |      35409      |   0.04800000000000   |
|      124	     |    2014-03-01   | 	    24        |      35409      |   0.06780000000000   |
|      124	     |    2014-04-01   | 	    12        |      35409      |   0.03390000000000   |
|      124	     |    2014-05-01   | 	    20        |      35409      |   0.05650000000000   |
|   .........    |   ............  |    ..........    |   ...........   |  ..................  |
|   .........    |   ............  |    ..........    |   ...........   |  ..................  |
|----------------|-----------------|------------------|-----------------|----------------------| */


-- El OVER() se base en la información que se proporciona en la sentencia WHERE. Veamos un ejemplo:

SELECT *, SUM(NumberAttendance) OVER() TotalAttendance,
	   ROUND(CONVERT(DECIMAL(5,3), NumberAttendance)/SUM(NumberAttendance) OVER() * 100,4)  AS PercentageAttendance
FROM tblAttendance
WHERE AttendanceMonth < '20150101'

/*
|----------------|-----------------|------------------|-----------------|----------------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance | TotalAttendance | PercentageAttendance |
|----------------|-----------------|------------------|-----------------|----------------------|
|      123	     |    2014-01-01   |	    14        |      17690      |   0.07910000000000   | <---- Vemos como el valor de 'TotalAttendance' cambió 
|      123	     |    2014-02-01   |	    12        |      17690      |   0.06780000000000   |       y eso provoca que 'PercentageAttendance' cambie 
|      123	     |    2014-03-01   |	    23        |      17690      |   0.13000000000000   |       también.
|      123       |    2014-04-01   | 	    21        |      17690      |   0.11870000000000   |  
|      123       |    2014-05-01   |    	23        |      17690      |   0.13000000000000   | 
|      123       |    2014-06-01   |	    14        |      17690      |   0.07910000000000   |  
|      123       |    2014-07-01   |	    11        |      17690      |   0.06220000000000   |  
|      123       |    2014-08-01   | 	    15        |      17690      |   0.08480000000000   |
|      123	     |    2014-09-01   | 	    14        |      17690      |   0.07910000000000   |
|      123	     |    2014-10-01   | 	    20        |      17690      |   0.11310000000000   |
|      123	     |    2014-11-01   | 	    24        |      17690      |   0.13570000000000   |
|      123	     |    2014-12-01   | 	    14        |      17690      |   0.07910000000000   |
|      124	     |    2014-01-01   | 	    17        |      17690      |   0.09610000000000   |
|      124	     |    2014-02-01   | 	    17        |      17690      |   0.09610000000000   |
|      124	     |    2014-03-01   | 	    24        |      17690      |   0.13570000000000   |
|      124	     |    2014-04-01   | 	    12        |      17690      |   0.06780000000000   |
|      124	     |    2014-05-01   | 	    20        |      17690      |   0.11310000000000   |
|   .........    |   ............  |    ..........    |   ...........   |  ..................  |
|   .........    |   ............  |    ..........    |   ...........   |  ..................  |
|----------------|-----------------|------------------|-----------------|----------------------| */