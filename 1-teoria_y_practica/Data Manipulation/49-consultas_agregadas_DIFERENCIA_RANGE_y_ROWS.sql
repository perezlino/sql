-- ======================================================
-- ==== CONSULTAS AGREGADAS - DIFERENCIA RANGE Y ROWS ===
-- ======================================================

/*
|------------------------------------------------------------------------------------------------------------|
|   NOTA IMPORTANTE:                                                                                         |       
|   ===============                                                                                          |   
|                                                                                                            |                   
|   RANGE sólo es compatible con delimitadores de ventana (window frame delimeters) UNBOUNDED y CURRENT ROW. |
|                                                                                                            |
|------------------------------------------------------------------------------------------------------------|


Veamos algunos ejemplos para que se entienda la diferencia:    */

SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth) 
									 ORDER BY AttendanceMonth ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) RowsTotal,
		  SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth) 
									 ORDER BY AttendanceMonth RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) RangeTotal
FROM tblAttendance

--  Dado que particionamos los datos por 'EmployeeNumber' y por el año del campo 'AttendanceMonth', al momento de 
--  realizar el acumulado ROWS trabajará FILA A FILA respetando la partición realizada. RANGE también respeta la
--  partición realizada, y realizará el acumulado de acuerdo al campo AttendanceMonth.

/*
|----------------|-----------------|------------------|-----------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance |    RowsTotal    |    RangeTotal   |
|----------------|-----------------|------------------|-----------------|-----------------|
|      123	     |    2014-01-01   |	    14        |       14        |       14        |
|      123	     |    2014-02-01   |	    12        |       26        |       26        |
|      123	     |    2014-03-01   |	    23        |       49        |       49        |  
|      123       |    2014-04-01   | 	    21        |       70        |       70        |   
|      123       |    2014-05-01   |    	23        |       93        |       93        |  
|      123       |    2014-06-01   |	    14        |      107        |      107        |  
|      123       |    2014-07-01   |	    11        |      118        |      118        | 
|      123       |    2014-08-01   | 	    15        |      133        |      133        |  
|      123	     |    2014-09-01   | 	    14        |      147        |      147        |  
|      123	     |    2014-10-01   | 	    20        |      167        |      167        |  
|      123	     |    2014-11-01   | 	    24        |      191        |      191        |  
|      123	     |    2014-12-01   | 	    14        |      205        |      205        |
|      123	     |    2015-01-01   | 	    21        |       21        |       21        |  
|      123	     |    2015-02-01   | 	    16        |       37        |       37        |  
|      123	     |    2015-03-01   | 	    17        |       54        |       54        |  
|      123	     |    2015-04-01   | 	    13        |       67        |       67        |  
|      123	     |    2015-05-01   | 	    11        |       78        |       78        |  
|      123	     |    2015-06-01   | 	    18        |       96        |       96        |  
|      123	     |    2015-07-01   | 	    24        |      120        |      120        |  
|      123	     |    2015-08-01   | 	    15        |      135        |      135        |  
|      123	     |    2015-09-01   | 	    19        |      154        |      154        |  
|      123	     |    2015-10-01   | 	    20        |      174        |      174        | 
|      124	     |    2014-01-01   | 	    17        |       17        |       17        |  
|      124	     |    2014-02-01   | 	    17        |       34        |       34        |  
|      124	     |    2014-03-01   | 	    24        |       58        |       58        |  
|      124	     |    2014-04-01   | 	    12        |       70        |       70        |  
|      124	     |    2014-05-01   | 	    20        |       90        |       90        |
|   .........    |   ............  |    ..........    |   ...........   |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |   ...........   |
|----------------|-----------------|------------------|-----------------|-----------------|  */


SELECT *, SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth) 
									 ORDER BY EmployeeNumber ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) RowsTotal,
		  SUM(NumberAttendance) OVER(PARTITION BY EmployeeNumber, YEAR(AttendanceMonth) 
									 ORDER BY EmployeeNumber RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) RangeTotal
FROM tblAttendance

/*
|----------------|-----------------|------------------|-----------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance |    RowsTotal    |    RangeTotal   |
|----------------|-----------------|------------------|-----------------|-----------------|
|      123	     |    2014-01-01   |	    14        |       14        |      205        |
|      123	     |    2014-02-01   |	    12        |       26        |      205        |
|      123	     |    2014-03-01   |	    23        |       49        |      205        |  
|      123       |    2014-04-01   | 	    21        |       70        |      205        |   
|      123       |    2014-05-01   |    	23        |       93        |      205        |  
|      123       |    2014-06-01   |	    14        |      107        |      205        |  
|      123       |    2014-07-01   |	    11        |      118        |      205        | 
|      123       |    2014-08-01   | 	    15        |      133        |      205        |  
|      123	     |    2014-09-01   | 	    14        |      147        |      205        |  
|      123	     |    2014-10-01   | 	    20        |      167        |      205        |  
|      123	     |    2014-11-01   | 	    24        |      191        |      205        |  
|      123	     |    2014-12-01   | 	    14        |      205        |      205        |
|      123	     |    2015-01-01   | 	    21        |       21        |      174        |  
|      123	     |    2015-02-01   | 	    16        |       37        |      174        |  
|      123	     |    2015-03-01   | 	    17        |       54        |      174        |  
|      123	     |    2015-04-01   | 	    13        |       67        |      174        |  
|      123	     |    2015-05-01   | 	    11        |       78        |      174        |  
|      123	     |    2015-06-01   | 	    18        |       96        |      174        |  
|      123	     |    2015-07-01   | 	    24        |      120        |      174        |  
|      123	     |    2015-08-01   | 	    15        |      135        |      174        |  
|      123	     |    2015-09-01   | 	    19        |      154        |      174        |  
|      123	     |    2015-10-01   | 	    20        |      174        |      174        | 
|      124	     |    2014-01-01   | 	    17        |       17        |      228        |  
|      124	     |    2014-02-01   | 	    17        |       34        |      228        |  
|      124	     |    2014-03-01   | 	    24        |       58        |      228        |  
|      124	     |    2014-04-01   | 	    12        |       70        |      228        |  
|      124	     |    2014-05-01   | 	    20        |       90        |      228        |
|   .........    |   ............  |    ..........    |   ...........   |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |   ...........   |
|----------------|-----------------|------------------|-----------------|-----------------|  */


SELECT 
	A.EmployeeNumber, 
	A.AttendanceMonth, 
	A.NumberAttendance, 
    SUM(A.NumberAttendance) OVER(PARTITION BY A.EmployeeNumber, YEAR(A.AttendanceMonth) 
									 ORDER BY A.AttendanceMonth ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) RowsTotal,
    SUM(A.NumberAttendance) OVER(PARTITION BY A.EmployeeNumber, YEAR(A.AttendanceMonth) 
									 ORDER BY A.AttendanceMonth RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) RangeTotal
FROM 
	tblAttendance A
INNER JOIN 
	(SELECT * FROM tblAttendance UNION ALL SELECT * FROM tblAttendance) AS B
ON 
	A.EmployeeNumber = B.EmployeeNumber
AND 
	A.AttendanceMonth = B.AttendanceMonth
ORDER BY 
	A.EmployeeNumber, A.AttendanceMonth

/*
|----------------|-----------------|------------------|-----------------|-----------------|
| EmployeeNumber | AttendanceMonth | NumberAttendance |    RowsTotal    |    RangeTotal   |
|----------------|-----------------|------------------|-----------------|-----------------|
|      123	     |    2014-01-01   |	    14        |       14        |       28        |
|      123	     |    2014-01-01   |	    14        |       28        |       28        |
|      123	     |    2014-02-01   |	    12        |       40        |       52        |
|      123	     |    2014-02-01   |	    12        |       52        |       52        |
|      123	     |    2014-03-01   |	    23        |       75        |       98        |
|      123	     |    2014-03-01   |	    23        |       98        |       98        |
|      123       |    2014-04-01   | 	    21        |      119        |      140        | 
|      123       |    2014-04-01   | 	    21        |      140        |      140        | 
|      123       |    2014-05-01   |    	23        |      163        |      186        |
|      123       |    2014-05-01   |    	23        |      186        |      186        |
|      123       |    2014-06-01   |	    14        |      200        |      214        |  
|      123       |    2014-06-01   |	    14        |      214        |      214        |
|      123       |    2014-07-01   |	    11        |      225        |      236        | 
|      123       |    2014-07-01   |	    11        |      236        |      236        | 
|      123       |    2014-08-01   | 	    15        |      251        |      266        |  
|      123       |    2014-08-01   | 	    15        |      266        |      266        |  
|      123	     |    2014-09-01   | 	    14        |      280        |      294        |  
|      123	     |    2014-09-01   | 	    14        |      294        |      294        | 
|      123	     |    2014-10-01   | 	    20        |      314        |      334        |  
|      123	     |    2014-10-01   | 	    20        |      334        |      334        |  
|      123	     |    2014-11-01   | 	    24        |      358        |      382        |  
|      123	     |    2014-11-01   | 	    24        |      382        |      382        |  
|      123	     |    2014-12-01   | 	    14        |      396        |      410        |
|      123	     |    2014-12-01   | 	    14        |      410        |      410        |
|      123	     |    2015-01-01   | 	    21        |       21        |       42        |  
|      123	     |    2015-01-01   | 	    21        |       42        |       42        |
|      123	     |    2015-02-01   | 	    16        |       58        |       74        |  
|      123	     |    2015-02-01   | 	    16        |       74        |       74        | 
|      123	     |    2015-03-01   | 	    17        |       91        |      108        |  
|      123	     |    2015-03-01   | 	    17        |      108        |      108        | 
|      123	     |    2015-04-01   | 	    13        |      121        |      134        |  
|      123	     |    2015-04-01   | 	    13        |      134        |      134        |  
|      123	     |    2015-05-01   | 	    11        |      145        |      156        |  
|      123	     |    2015-05-01   | 	    11        |      156        |      156        | 
|      123	     |    2015-06-01   | 	    18        |      174        |      192        |  
|      123	     |    2015-06-01   | 	    18        |      192        |      192        |  
|      123	     |    2015-07-01   | 	    24        |      216        |      240        |  
|      123	     |    2015-07-01   | 	    24        |      240        |      240        | 
|      123	     |    2015-08-01   | 	    15        |      255        |      270        |  
|      123	     |    2015-08-01   | 	    15        |      270        |      270        | 
|      123	     |    2015-09-01   | 	    19        |      289        |      308        |  
|      123	     |    2015-09-01   | 	    19        |      308        |      308        | 
|      123	     |    2015-10-01   | 	    20        |      328        |      348        | 
|      123	     |    2015-10-01   | 	    20        |      348        |      348        | 
|      124	     |    2014-01-01   | 	    17        |       17        |       34        |  
|      124	     |    2014-01-01   | 	    17        |       34        |       34        | 
|      124	     |    2014-02-01   | 	    17        |       51        |       68        |  
|      124	     |    2014-02-01   | 	    17        |       68        |       68        | 
|      124	     |    2014-03-01   | 	    24        |       92        |      116        |  
|      124	     |    2014-03-01   | 	    24        |      116        |      116        | 
|      124	     |    2014-04-01   | 	    12        |      128        |      140        |  
|      124	     |    2014-04-01   | 	    12        |      140        |      140        |  
|      124	     |    2014-05-01   | 	    20        |      160        |      180        |
|      124	     |    2014-05-01   | 	    20        |      180        |      180        |
|   .........    |   ............  |    ..........    |   ...........   |   ...........   |
|   .........    |   ............  |    ..........    |   ...........   |   ...........   |
|----------------|-----------------|------------------|-----------------|-----------------|  */